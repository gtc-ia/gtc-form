<!-- ...предыдущая разметка до формы... -->
<form id="gtc-form" method="POST" action="https://kfilipenko.app.n8n.cloud/webhook/user-access" target="_blank" onsubmit="return handleFormSubmit(event)">
  <!-- Select mode -->
  <label for="mode">Select an action:</label>
  <select name="mode" id="mode" required>
    <option value="login" selected>Login</option>
    <option value="register">Register</option>
  </select>

  <!-- Email -->
  <label for="email">Email</label>
  <input type="email" id="email" name="email" required />

  <!-- Name — shown only for register -->
  <div id="name-group" style="display: none;">
    <label for="name">Name (only when registering)</label>
    <input type="text" id="name" name="name" />
  </div>

  <!-- Password -->
  <label for="password">Password</label>
  <input type="password" id="password" name="password" required />

  <!-- Source -->
  <label for="source">Source</label>
  <select name="source" id="source" required>
    <option value="telegram">Telegram</option>
    <option value="web">Web</option>
    <option value="github">GitHub</option>
    <option value="wix">Wix</option>
    <option value="tilda">Tilda</option>
    <option value="other">Other</option>
  </select>

  <!-- Prompt -->
  <label for="prompt">Your question or request</label>
  <textarea id="prompt" name="prompt" rows="4" required></textarea>

  <input type="hidden" name="executionMode" value="user-form" />
  <button type="submit">Continue</button>

  <!-- Response block -->
  <div id="response-block" style="display:none; margin-top:1em; color: #8bc34a; text-align: center;">
    ✅ Data written successfully
  </div>
</form>

<!-- JS -->
<script>
  const form = document.getElementById("gtc-form");
  const nameGroup = document.getElementById("name-group");
  const modeSelect = document.getElementById("mode");
  const responseBlock = document.getElementById("response-block");

  // Toggle name field on mode change
  modeSelect.addEventListener("change", () => {
    nameGroup.style.display = modeSelect.value === "register" ? "block" : "none";
  });

  function handleFormSubmit(event) {
    event.preventDefault();
    const formData = new FormData(form);
    const plainData = Object.fromEntries(formData.entries());
    plainData.password = btoa(unescape(encodeURIComponent(plainData.password))); // base64 password

    fetch(form.action, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(plainData),
    })
    .then(res => res.json())
    .then(data => {
      form.style.display = "none";
      responseBlock.innerText = "✅ Data written successfully"; // Replace if backend returns RU
      responseBlock.style.display = "block";
    })
    .catch(error => {
      responseBlock.innerText = "❌ Submission failed. Please try again.";
      responseBlock.style.color = "#f44336";
      responseBlock.style.display = "block";
    });

    return false;
  }
</script>
